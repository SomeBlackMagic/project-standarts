# Правила написания докер контейнеров для проекта


### В продакшн образе не должно быть ничего лишних
Для того чтоб не подвергать продакшен лишней уязвимости стоит из продакшн образа удалять все установщики зависимости, компиляторов, etc. 
Вот примерный список того что НЕ должен содержать докер образ после сборки
* npm,yarn
* composer
* pip
* gcc
* Maven
* Cargo
* Go

### Динамический `ENTRYPOINT`
Очень часто бывают случии когда для отладкит пред запуском главного процесса(`CMD`) нужно добавить какие-то проверки соединений с базой, чеки готовности других сервисов которые можно телать только на этапе предзапуска контейнера.
В таком случае entrypoint должен быть код который умеет читать файли из папки, и исполнять скрипты, для гибкого добавления нужных действий перед стартом контейнера:
```
# Path to scripts to source
CONFIG_DIR="/docker-entrypoint.d"

init="$( find "${CONFIG_DIR}" -name '*.sh' -type f | sort -u )"
for f in ${init}; do
 # shellcheck disable=SC1090
 echo "[Entrypoint] running $f"
 . "${f}"
done

```
Такой код даёт нам возможность встраивать(монтировать в том числе) в контейнер динамические скрипты, а так-же упралять их порядком запуска

### Прогрев кешей который не требует внешних сервисов происходит при сборке образа
Для экономии времени запуска контейнера сдедует прогревать все возможние кеши которые для этого не требует никаких спецыфических данных в пайплайнах.
Пример:
* php(Symfony) -  выполнять cache:warmap
* Protobuf - компиляция proto файлов

### Желательно: Добавлять в докерфайл тесты установленных библиотк и расширений
Для более быстрого выявляеня проблем связаных с обновлением библиотке рекомендуется после установки каждой библиотки(расширения) проверять её на корректность установки. 
Пример:
  * php - после установки модуля следует выполнить ``` php -m | grep -oiE '^MODULE_NAME' \  ```

### Правельная инвалидация кеша 
#### В начале модули потом настроойки
По статистике настройки системы меняются чаще чем библиоткеи которые нужны для работы приложения. Потому следует в начале сборки установить все библиоткеи а после уже копировать в контейнер конфигурационные файлы
#### В начале записимости а потом код
По статистике код меняется чаще чем список зависимостей, потому для более быстрой сборки рекомендуется такая последовательность действий
* Скопировать в контейнер файл(ы) в которых находится список зависимостей
* Установить зависимости
* Скопировать весь остальной код в контейнер
* Выполнить компиляцию(в случае компилируемых языков)
5. При сборке образа с модулями вначале должна быть компиляция модулей а после добавления конфиг файлов для правельной инвалидации докер кеша
