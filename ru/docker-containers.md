# Правила написания докер контейнеров для проекта


### В продакшн образе не должно быть ничего лишних
Для того чтоб не подвергать продакшн лишней уязвимости стоит из продакшн образа удалять все установщики зависимости, компиляторов, etc. 
Вот примерный список того что НЕ должен содержать докер образ после сборки
* npm,yarn
* composer
* pip
* gcc
* Maven
* Cargo
* Go

### Динамический `ENTRYPOINT`
Очень часто бывают случаи когда для отладки пред запуском главного процесса(`CMD`) нужно добавить какие-то проверки соединений с базой, чеки готовности других сервисов которые можно делать только на этапе предзапуска контейнера.
В таком случае entrypoint должен быть код, который умеет читать файлы из папки, и исполнять скрипты, для гибкого добавления нужных действий перед стартом контейнера:
```
# Path to scripts to source
CONFIG_DIR="/docker-entrypoint.d"

init="$( find "${CONFIG_DIR}" -name '*.sh' -type f | sort -u )"
for f in ${init}; do
 # shellcheck disable=SC1090
 echo "[Entrypoint] running $f"
 . "${f}"
done

```
Такой код даёт нам возможность встраивать(монтировать, в том числе) в контейнер динамические скрипты, а так-же управлять их порядком запуска

### Частичный прогрев кешей при сборке образа
Для экономии времени запуска контейнера следует прогревать всевозможные кеши которые для этого не требует никаких специфических данных в пайплайнах.
Пример:
* php(Symfony) -  выполнять cache:warmap
* Protobuf - компиляция proto файлов

### Желательно: Добавлять в докерфайл тесты установленных библиотек и расширений
Для более быстрого выявления проблем связанных с обновлением библиотек рекомендуется после установки каждой библиотеки(расширения) проверять её на корректность установки. 
Пример:
  * php - после установки модуля следует выполнить ``` php -m | grep -oiE '^MODULE_NAME' \  ```

### Правильная инвалидация кеша

#### В начале модули, потом настройки
По статистике настройки системы меняются чаще чем библиотеки которые нужны для работы приложения. Потому следует в начале сборки установить все библиоткеи, а после уже копировать в контейнер конфигурационные файлы
#### В начале зависимости, а потом код
По статистике код меняется чаще чем список зависимостей, потому для более быстрой сборки рекомендуется такая последовательность действий
* Скопировать в контейнер файл(ы) в которых находится список зависимостей
* Установить зависимости
* Скопировать весь остальной код в контейнер
* Выполнить компиляцию(в случае компилируемых языков)
